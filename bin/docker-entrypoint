#!/bin/bash -e

# Enable jemalloc for reduced memory usage and latency.
if [ -z "${LD_PRELOAD+x}" ] && [ -f "/usr/lib/$(uname -m)-linux-gnu/libjemalloc.so.2" ]; then
    export LD_PRELOAD="/usr/lib/$(uname -m)-linux-gnu/libjemalloc.so.2"
elif [ -z "${LD_PRELOAD+x}" ]; then
    JEMALLOC_PATH=$(find /usr/lib -name "libjemalloc.so.2" -print -quit 2>/dev/null)
    if [ -n "$JEMALLOC_PATH" ]; then
        export LD_PRELOAD="$JEMALLOC_PATH"
    fi
fi

# Ensure bundle is set up correctly
echo "Setting up bundler..."
cd /app
bundle install --local || bundle install

# If running Rails commands that need database access, prepare the database
if [[ "$*" =~ rails && ( "$*" =~ server || "$*" =~ console || "$*" =~ runner || "$*" =~ jobs ) ]]; then
  echo "Preparing database..."
  ./bin/rails db:prepare
fi

exec "${@}"
