version: '3.8'

services:
  db:
    image: postgres:14
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-tmcp_production}
      POSTGRES_USER: ${POSTGRES_USER:-tmcp}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-tmcp_password}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-tmcp} -d ${POSTGRES_DB:-tmcp_production}"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  tmcp-server:
    build: .
    environment:
      # Rails Configuration
      RAILS_ENV: ${RAILS_ENV:-development}
      DATABASE_URL: ${DATABASE_URL:-postgresql://tmcp:tmcp_password@db:5432/tmcp_production}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
      SECRET_KEY_BASE: ${SECRET_KEY_BASE:-development_secret_key_base_change_in_production}
      BUNDLE_PATH: ${BUNDLE_PATH:-/usr/local/bundle}
      
      # TMCP Server Configuration
      TMCP_JWT_ISSUER: ${TMCP_JWT_ISSUER:-http://localhost:3000}
      TMCP_JWT_KEY_ID: ${TMCP_JWT_KEY_ID:-tmcp-2025-01}
      
      # Matrix Homeserver (Synapse) Configuration
      MATRIX_API_URL: ${MATRIX_API_URL:-https://core.tween.im}
      MATRIX_HS_TOKEN: ${MATRIX_HS_TOKEN:-EXV6pIIy3zp9vxKYaNFOxKYkwNiqLwDB}
      MATRIX_ACCESS_TOKEN: ${MATRIX_ACCESS_TOKEN:-development_access_token}

      # Matrix Authentication Service (MAS) Configuration
      MAS_URL: ${MAS_URL:-https://mas.tween.example}
      MAS_CLIENT_ID: ${MAS_CLIENT_ID:-tmcp-server}
      MAS_CLIENT_SECRET: ${MAS_CLIENT_SECRET:-}
      MAS_TOKEN_URL: ${MAS_TOKEN_URL:-https://mas.tween.example/oauth2/token}
      MAS_INTROSPECTION_URL: ${MAS_INTROSPECTION_URL:-https://mas.tween.example/oauth2/introspect}
      MAS_REVOCATION_URL: ${MAS_REVOCATION_URL:-https://mas.tween.example/oauth2/revoke}

      # Security Configuration
      FORCE_SSL: ${FORCE_SSL:-false}
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-http://localhost:3000}
      
      # File paths for sensitive credentials (loaded from mounted secrets)
      TMCP_PRIVATE_KEY_FILE: ${TMCP_PRIVATE_KEY_FILE:-/run/secrets/tmcp_private_key}
      MAS_CLIENT_SECRET_FILE: ${MAS_CLIENT_SECRET_FILE:-/run/secrets/mas_client_secret}
    volumes:
      - bundle:/usr/local/bundle
      # Mount secret files (use Docker secrets or host files)
      - ./secrets:/run/secrets:ro
    secrets:
      - tmcp_private_key
      - mas_client_secret
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    entrypoint: ["/app/bin/docker-entrypoint"]
    command: ["bundle", "exec", "rails", "server", "-b", "0.0.0.0", "-p", "3000"]
    stdin_open: true
    tty: true

secrets:
  tmcp_private_key:
    file: ./secrets/tmcp_private_key.txt
  mas_client_secret:
    file: ./secrets/mas_client_secret.txt

volumes:
  postgres_data:
  redis_data:
  bundle:
